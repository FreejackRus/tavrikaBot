# TavrikaBot — новая модульная структура

Проект сформирован заново: модульная структура для получения данных из IIKO (авторизация сохранена), расчёта отчёта за день и отправки сообщения в Telegram.

## Структура проекта

Основные файлы:

```
bot.py         # Telegram-бот: команда /cashflow формирует и отправляет отчёты ДДС
iiko_client.py # Клиент IIKO: авторизация и OLAP TRANSACTIONS
cashflow.py    # Построение сводных и детальных таблиц ДДС
README.md      # Документация
requirements.txt
.env.example   # Пример переменных окружения
.gitignore
```

## Окружение

Создайте файл `.env` и заполните:

```
IIKO_BASE_URL=https://tavrika-wine-kitchen.iiko.it:443
IIKO_LOGIN=your_login
IIKO_PASSWORD=your_password

TELEGRAM_BOT_TOKEN=your_bot_token
CHAT_ID=your_chat_id
```

Авторизация в IIKO оставлена как в оригинальном проекте: сначала запрос `/resto/api/auth` для получения токена, затем параметр `key` используется в запросах OLAP.

## Логика и последовательность

- Запрос 1: получаем конечные остатки на предыдущий день (например, `2025-10-08`).
- Запрос 2: получаем движения за текущий день (например, `2025-10-09`).
- Расчёт: начальные остатки = конечные остатки предыдущего дня; считаем итог за день и формируем HTML-таблицу.

## Запуск

Установите зависимости:

```
python -m venv .venv
./.venv/Scripts/python -m pip install -r requirements.txt
```

Запуск Telegram-бота:

```
./.venv/Scripts/python bot.py
```

Команда в чате:
- `/cashflow YYYY-MM-DD` — отчёт за день (начальный остаток берётся как конечный предыдущего дня)
- `/cashflow YYYY-MM-DD YYYY-MM-DD` — отчёт за период
- Без аргументов — отчёт за вчера—сегодня

Отчёт также экспортируется в файлы `cashflow.xlsx` (сводный) и `cashflow_detailed.xlsx` (детальный) в корне проекта.